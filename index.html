<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Facebook-chef-cookbooks by page2me</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header class="without-description">
        <h1>Facebook-chef-cookbooks</h1>
        <p></p>
        <p class="view"><a href="https://github.com/page2me/facebook-chef-cookbooks">View the Project on GitHub <small>page2me/facebook-chef-cookbooks</small></a></p>
        <ul>
          <li><a href="https://github.com/page2me/facebook-chef-cookbooks/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/page2me/facebook-chef-cookbooks/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/page2me/facebook-chef-cookbooks">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="facebook-cookbooks-suite" class="anchor" href="#facebook-cookbooks-suite" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Facebook Cookbooks Suite</h1>

<p><a href="http://travis-ci.org/facebook/chef-cookbooks"><img src="https://travis-ci.org/facebook/chef-cookbooks.svg" alt="Build Status"></a></p>

<p>This repo contains attribute-driven-API cookbooks maintained by Facebook. It's
a large chunk of what we refer to as our "core cookbooks."</p>

<p>It's worth reading our
<a href="https://github.com/facebook/chef-utils/blob/master/Philosophy.md">Philosophy.md</a>
doc before reading this. It covers how we use Chef and is important context
before reading this.</p>

<p>It is important to note that these cookbooks are built using a very specific
model that's very different from most other cookbooks in the community.
Specifically:</p>

<ul>
<li>It assumes an environment in which you want to delegate. The cookbooks are
designed to be organized in a "least specific to most specific" order in the
runlist. The runlist starts with the "core cookbooks" that setup APIs and
enforce a base standard, which can be adjusted by the service owners using
cookbooks later in the runlist.</li>
<li>It assumes a "run from master" type environment. At Facebook we use <a href="http://www.github.com/facebook/grocery-delivery">Grocery
Delivery</a> to sync the master
branch of our git repo with all of our Chef servers. Grocery Delivery is not
necessary to use these cookbooks, but since they were built with this model in
mind, the versions never change (relatedly: we do not use environments).</li>
<li>It assumes you have a testing toolset that allows anyone modifying later
cookbooks to ensure that their use of the API worked as expected on a live
node before committing. For this, we use <a href="http://www.github.com/facebook/taste-tester">Taste
Tester</a>.</li>
</ul>

<h2>
<a id="apis" class="anchor" href="#apis" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>APIs</h2>

<p>Unlike other cookbook models, we do not use resources as APIs, we use the node
object. Configuration is modeled in arrays and hashes as closely and thinly as
possible to the service we are configuring. Ideally, you should only have to
read the docs to the service to configure it, not the docs to the cookbook.</p>

<p>For example, if the service we are configuring has a key-value pair
configuration file, we will provide a simple hash where keys and values will be
directly put into the necessary configuration file.</p>

<p>There are two reasons we use attribute-driven APIs:</p>

<ol>
<li>
<p>Since our cookbooks are ordered least specific (core team that owns Chef) to
most specific (the team that owns this machine or service) it means that the
team who cares about this specific instance to always override anything. This
enables stacking that is not possible in many other models. For example, you
can have a runlist that looks like:</p>

<ul>
<li>Core cookbooks (the ones in this repo)</li>
<li>Site/Company cookbooks (site-specific settings)</li>
<li>Region cookbooks (overrides for a given region/cluster)</li>
<li>Application Category cookbooks (webserver, mail server, etc.)</li>
<li>Specific Application cookbook ("internal app1 servier")</li>
</ul>

<p>So let's say that you want a specific amount of shared memory by default,
but in some region you know you have different size machines, so you shrink
it, but web servers need a further different setting, and then finally some
specific internal webserver needs an even more specific setting... this all
just works.</p>

<p>Further, a cookbook can see the value that was set before it modifies things,
so the 'webserver' cookbook could look to see if what the value was (small or
large) before modifying it and adjust it accordingly (so it could be relative
to the size of memory that the 'region' cookbook set.</p>
</li>
<li>
<p>Allows for what we refer to as "idempotent systems" instead of "idempotent
settings." In other words, if you only manage a specific item in a larger
config, and then you stop managing it, it should either revert to a
less-specific setting (see #1) or be removed, as necessary.</p>

<p>For example let's say you want to set a cron job. If you use the internal
cron resource, and then delete the recipe code that adds that cronjob, that
cron isn't removed from your production environment - it's on all existing
nodes, but not on any new nodes.</p>

<p>For this reason we use templates to take over a whole configuration wherever
possible. All cron jobs in our fb_cron API are written to
/etc/cron.d/fb_crontab - one you delete the lines adding a cronjob, since
they are just entries in a hash, when the template is generated on the next
Chef run, those crons go away.</p>

<p>Alternatively, consider a sysctl set by the "site" cookbook, then overwritten
but a later cookbook. When they remove that code, the entry in the hash is
now that set by the "site" cookbook. Automatically it falls back to the
next-most-specific value</p>
</li>
</ol>

<h2>
<a id="runlists" class="anchor" href="#runlists" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Runlists</h2>

<p>How you formulate your runlists is up to your site, as long as you follow the
basic rule that core cookbooks come first and you order least-specific to
most-specific. At Facebook, all of our runlists are:</p>

<pre><code>recipe[fb_init], recipe[$SERVICE]
</code></pre>

<p>Where fb_init is similar to the sample provided in this repo, but with extra
"core cookbooks."</p>

<p>We generally think of this way: fb_init should make you a "Facebook server" and
the rest should make you a whatever-kind-of-server-you-are.</p>

<h2>
<a id="getting-started" class="anchor" href="#getting-started" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Getting started</h2>

<p>Grab a copy of the repo, rename <code>fb_init_sample</code> to fb_init, and follow the
instructions in the README.md (coordinating guidance is in comments in the
default recipe).</p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/page2me">page2me</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
